#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
åˆ†ææ£€æµ‹é—®é¢˜ - æ·±å…¥äº†è§£è§„åˆ™å’ŒAIæ£€æµ‹çš„å…·ä½“æƒ…å†µ
"""

import os
import sys
import asyncio
import json
from pathlib import Path

# è®¾ç½®ç¯å¢ƒå˜é‡
os.environ["FOCUS_COMPARE_ONLY"] = "0"
os.environ["ENABLE_RULES"] = "ALL"

from engine.rules_v33 import ALL_RULES, build_document, Issue
from schemas.issues import JobContext, AnalysisConfig, create_default_config
from services.engine_rule_runner import EngineRuleRunner
from services.ai_rule_runner import run_ai_rules_batch


def analyze_sample_files():
    """åˆ†ææ ·æœ¬æ–‡ä»¶"""
    print("ğŸ“ åˆ†ææ ·æœ¬æ–‡ä»¶")
    print("=" * 50)
    
    # æ ·æœ¬æ–‡ä»¶è·¯å¾„
    sample_files = {
        "é—®é¢˜æ–‡ä»¶1": "samples/bad/ä¸­å…±ä¸Šæµ·å¸‚æ™®é™€åŒºå§”ç¤¾ä¼šå·¥ä½œéƒ¨ 2024 å¹´åº¦éƒ¨é—¨å†³ç®—.pdf",
        "é—®é¢˜æ–‡ä»¶2": "samples/bad/ä¸Šæµ·å¸‚æ™®é™€åŒºè§„åˆ’å’Œè‡ªç„¶èµ„æºå±€ 2024 å¹´åº¦éƒ¨é—¨å†³ç®—.pdf",
        "æ­£å¸¸æ–‡ä»¶": "samples/good/ä¸Šæµ·å¸‚æ™®é™€åŒºè´¢æ”¿å±€2024å¹´åº¦éƒ¨é—¨å†³ç®—.pdf",
        "æ¨¡æ¿æ–‡ä»¶": "samples/templates/é™„ä»¶2ï¼šéƒ¨é—¨å†³ç®—æ¨¡æ¿.pdf"
    }
    
    for file_type, file_path in sample_files.items():
        print(f"\nğŸ“„ {file_type}: {file_path}")
        
        if not Path(file_path).exists():
            print(f"  âŒ æ–‡ä»¶ä¸å­˜åœ¨")
            continue
            
        # æ£€æŸ¥æ–‡ä»¶å¤§å°å’ŒåŸºæœ¬ä¿¡æ¯
        file_size = Path(file_path).stat().st_size
        print(f"  ğŸ“Š æ–‡ä»¶å¤§å°: {file_size:,} å­—èŠ‚")
        
        # å°è¯•è¯»å–PDFå†…å®¹ï¼ˆç®€å•æ£€æŸ¥ï¼‰
        try:
            import PyPDF2
            with open(file_path, 'rb') as f:
                pdf_reader = PyPDF2.PdfReader(f)
                num_pages = len(pdf_reader.pages)
                print(f"  ğŸ“„ é¡µæ•°: {num_pages}")
                
                # è¯»å–ç¬¬ä¸€é¡µæ–‡æœ¬
                if num_pages > 0:
                    first_page_text = pdf_reader.pages[0].extract_text()[:200]
                    print(f"  ğŸ“ é¦–é¡µé¢„è§ˆ: {first_page_text}...")
                    
        except Exception as e:
            print(f"  âš ï¸  PDFè¯»å–å¤±è´¥: {e}")


def analyze_rule_implementations():
    """åˆ†æè§„åˆ™å®ç°æƒ…å†µ"""
    print("\nğŸ” åˆ†æè§„åˆ™å®ç°æƒ…å†µ")
    print("=" * 50)
    
    print(f"ğŸ“Š æ€»è§„åˆ™æ•°é‡: {len(ALL_RULES)}")
    
    # æŒ‰è§„åˆ™ä»£ç åˆ†ç»„
    rule_groups = {}
    for rule in ALL_RULES:
        code_prefix = rule.code.split('-')[0]
        if code_prefix not in rule_groups:
            rule_groups[code_prefix] = []
        rule_groups[code_prefix].append(rule)
    
    for group, rules in rule_groups.items():
        print(f"\nğŸ“‹ {group} è§„åˆ™ç»„ ({len(rules)} æ¡):")
        for rule in rules:
            print(f"  - {rule.code}: {rule.desc}")


def test_rule_execution_detail():
    """è¯¦ç»†æµ‹è¯•è§„åˆ™æ‰§è¡Œ"""
    print("\nğŸ§ª è¯¦ç»†æµ‹è¯•è§„åˆ™æ‰§è¡Œ")
    print("=" * 50)
    
    # åˆ›å»ºæµ‹è¯•æ•°æ® - æ¨¡æ‹ŸçœŸå®çš„å†³ç®—æŠ¥å‘Šå†…å®¹
    test_page_texts = [
        """2024å¹´åº¦ä¸Šæµ·å¸‚æ™®é™€åŒºè´¢æ”¿å±€éƒ¨é—¨å†³ç®—
å•ä½ï¼šä¸‡å…ƒ

ç¬¬ä¸€éƒ¨åˆ† éƒ¨é—¨æ¦‚å†µ
ä¸€ã€ä¸»è¦èŒèƒ½
ï¼ˆä¸€ï¼‰è´¯å½»æ‰§è¡Œå›½å®¶æœ‰å…³è´¢æ”¿ã€ç¨æ”¶å·¥ä½œçš„æ–¹é’ˆæ”¿ç­–å’Œæ³•å¾‹ã€æ³•è§„ã€è§„ç« ã€‚

ç¬¬äºŒéƒ¨åˆ† 2024å¹´åº¦éƒ¨é—¨å†³ç®—è¡¨
ä¸€ã€æ”¶å…¥æ”¯å‡ºå†³ç®—æ€»è¡¨
äºŒã€æ”¶å…¥å†³ç®—è¡¨
ä¸‰ã€æ”¯å‡ºå†³ç®—è¡¨
å››ã€è´¢æ”¿æ‹¨æ¬¾æ”¶å…¥æ”¯å‡ºå†³ç®—æ€»è¡¨
äº”ã€ä¸€èˆ¬å…¬å…±é¢„ç®—è´¢æ”¿æ‹¨æ¬¾æ”¯å‡ºå†³ç®—è¡¨
å…­ã€ä¸€èˆ¬å…¬å…±é¢„ç®—è´¢æ”¿æ‹¨æ¬¾åŸºæœ¬æ”¯å‡ºå†³ç®—è¡¨
ä¸ƒã€ä¸€èˆ¬å…¬å…±é¢„ç®—è´¢æ”¿æ‹¨æ¬¾"ä¸‰å…¬"ç»è´¹æ”¯å‡ºå†³ç®—è¡¨
å…«ã€æ”¿åºœæ€§åŸºé‡‘é¢„ç®—è´¢æ”¿æ‹¨æ¬¾æ”¶å…¥æ”¯å‡ºå†³ç®—è¡¨
ä¹ã€å›½æœ‰èµ„æœ¬ç»è¥é¢„ç®—è´¢æ”¿æ‹¨æ¬¾æ”¶å…¥æ”¯å‡ºå†³ç®—è¡¨""",
        
        """æ”¶å…¥æ”¯å‡ºå†³ç®—æ€»è¡¨
ç¼–åˆ¶å•ä½ï¼šä¸Šæµ·å¸‚æ™®é™€åŒºè´¢æ”¿å±€
2024å¹´åº¦
é‡‘é¢å•ä½ï¼šä¸‡å…ƒ

é¡¹ç›®\næ æ¬¡\nå¹´åˆé¢„ç®—æ•°\nè°ƒæ•´é¢„ç®—æ•°\nå†³ç®—æ•°\n
ä¸€ã€ä¸€èˆ¬å…¬å…±é¢„ç®—è´¢æ”¿æ‹¨æ¬¾\n1\n8,500.00\n9,200.00\n9,150.00\näºŒã€æ”¿åºœæ€§åŸºé‡‘é¢„ç®—è´¢æ”¿æ‹¨æ¬¾\n2\n500.00\n800.00\n780.00\nä¸‰ã€å›½æœ‰èµ„æœ¬ç»è¥é¢„ç®—è´¢æ”¿æ‹¨æ¬¾\n3\n0.00\n0.00\n0.00\n
æœ¬å¹´æ”¶å…¥åˆè®¡\n\n9,000.00\n10,000.00\n9,930.00\n\næ”¯å‡ºæ€»è®¡\n\n9,000.00\n10,000.00\n9,930.00""",
        
        """ä¸‰å…¬ç»è´¹æ”¯å‡ºè¡¨
2024å¹´åº¦
é‡‘é¢å•ä½ï¼šä¸‡å…ƒ

é¡¹ç›®\nå†³ç®—æ•°\n
å› å…¬å‡ºå›½ï¼ˆå¢ƒï¼‰è´¹ç”¨\n15.20\nå…¬åŠ¡ç”¨è½¦è´­ç½®åŠè¿è¡Œç»´æŠ¤è´¹\n45.80\nå…¶ä¸­ï¼šå…¬åŠ¡ç”¨è½¦è´­ç½®è´¹\n0.00\nå…¬åŠ¡ç”¨è½¦è¿è¡Œç»´æŠ¤è´¹\n45.80\nå…¬åŠ¡æ¥å¾…è´¹\n12.50\n
åˆè®¡\n73.50"""
    ]
    
    # å¯¹åº”çš„è¡¨æ ¼æ•°æ®
    test_page_tables = [
        [],  # ç¬¬ä¸€é¡µæ²¡æœ‰è¡¨æ ¼
        [   # ç¬¬äºŒé¡µè¡¨æ ¼ - æ”¶å…¥æ”¯å‡ºå†³ç®—æ€»è¡¨
            [["é¡¹ç›®"], ["æ æ¬¡"], ["å¹´åˆé¢„ç®—æ•°"], ["è°ƒæ•´é¢„ç®—æ•°"], ["å†³ç®—æ•°"]],
            [["ä¸€ã€ä¸€èˆ¬å…¬å…±é¢„ç®—è´¢æ”¿æ‹¨æ¬¾"], ["1"], ["8,500.00"], ["9,200.00"], ["9,150.00"]],
            [["äºŒã€æ”¿åºœæ€§é¢„ç®—è´¢æ”¿æ‹¨æ¬¾"], ["2"], ["500.00"], ["800.00"], ["780.00"]],
            [["ä¸‰ã€å›½æœ‰èµ„æœ¬ç»è¥é¢„ç®—è´¢æ”¿æ‹¨æ¬¾"], ["3"], ["0.00"], ["0.00"], ["0.00"]],
            [["æœ¬å¹´æ”¶å…¥åˆè®¡"], [""], ["9,000.00"], ["10,000.00"], ["9,930.00"]],
            [["æ”¯å‡ºæ€»è®¡"], [""], ["9,000.00"], ["10,000.00"], ["9,930.00"]]
        ],
        [   # ç¬¬ä¸‰é¡µè¡¨æ ¼ - ä¸‰å…¬ç»è´¹æ”¯å‡ºè¡¨
            [["é¡¹ç›®"], ["å†³ç®—æ•°"]],
            [["å› å…¬å‡ºå›½ï¼ˆå¢ƒï¼‰è´¹ç”¨"], ["15.20"]],
            [["å…¬åŠ¡ç”¨è½¦è´­ç½®åŠè¿è¡Œç»´æŠ¤è´¹"], ["45.80"]],
            [["å…¶ä¸­ï¼šå…¬åŠ¡ç”¨è½¦è´­ç½®è´¹"], ["0.00"]],
            [["å…¬åŠ¡ç”¨è½¦è¿è¡Œç»´æŠ¤è´¹"], ["45.80"]],
            [["å…¬åŠ¡æ¥å¾…è´¹"], ["12.50"]],
            [["åˆè®¡"], ["73.50"]]
        ]
    ]
    
    # æ„å»ºæ–‡æ¡£
    document = build_document(
        path="test_budget_report.pdf",
        page_texts=test_page_texts,
        page_tables=test_page_tables,
        filesize=1024000
    )
    
    print(f"ğŸ“„ æµ‹è¯•æ–‡æ¡£æ„å»ºå®Œæˆ")
    print(f"   é¡µæ•°: {len(test_page_texts)}")
    print(f"   è¡¨æ ¼æ•°: {sum(len(tables) for tables in test_page_tables)}")
    
    # æµ‹è¯•å…³é”®è§„åˆ™
    key_rules = ["V33-001", "V33-002", "V33-110"]
    
    for rule_code in key_rules:
        print(f"\nğŸ” æµ‹è¯•è§„åˆ™ {rule_code}:")
        
        # æŸ¥æ‰¾è§„åˆ™
        rule = None
        for r in ALL_RULES:
            if r.code == rule_code:
                rule = r
                break
        
        if not rule:
            print(f"  âŒ è§„åˆ™æœªæ‰¾åˆ°")
            continue
            
        print(f"  ğŸ“‹ è§„åˆ™æè¿°: {rule.desc}")
        
        try:
            # æ‰§è¡Œè§„åˆ™
            issues = rule.apply(document)
            print(f"  âœ… æ‰§è¡ŒæˆåŠŸï¼Œå‘ç°é—®é¢˜: {len(issues)}")
            
            for i, issue in enumerate(issues):
                print(f"    {i+1}. {issue.title}")
                if hasattr(issue, 'message'):
                    print(f"       {issue.message}")
                if hasattr(issue, 'page_number'):
                    print(f"       é¡µé¢: {issue.page_number}")
                    
        except Exception as e:
            print(f"  âŒ æ‰§è¡Œå¤±è´¥: {e}")
            import traceback
            traceback.print_exc()


async def test_ai_detection():
    """æµ‹è¯•AIæ£€æµ‹"""
    print("\nğŸ¤– æµ‹è¯•AIæ£€æµ‹")
    print("=" * 50)
    
    # åˆ›å»ºæµ‹è¯•æ–‡æ¡£æ•°æ®
    test_doc = type('TestDoc', (), {})()
    test_doc.page_texts = [
        """2024å¹´åº¦ä¸Šæµ·å¸‚æ™®é™€åŒºè´¢æ”¿å±€éƒ¨é—¨å†³ç®—
        
        ç¬¬ä¸€éƒ¨åˆ† éƒ¨é—¨æ¦‚å†µ
        ä¸Šæµ·å¸‚æ™®é™€åŒºè´¢æ”¿å±€æ˜¯ä¸»ç®¡å…¨åŒºè´¢æ”¿å·¥ä½œçš„èŒèƒ½éƒ¨é—¨ã€‚
        
        ç¬¬äºŒéƒ¨åˆ† 2024å¹´åº¦éƒ¨é—¨å†³ç®—è¡¨
        åŒ…å«æ”¶å…¥æ”¯å‡ºå†³ç®—æ€»è¡¨ã€æ”¶å…¥å†³ç®—è¡¨ã€æ”¯å‡ºå†³ç®—è¡¨ç­‰ä¹å¼ è¡¨æ ¼ã€‚
        
        ç¬¬ä¸‰éƒ¨åˆ† 2024å¹´åº¦éƒ¨é—¨å†³ç®—æƒ…å†µè¯´æ˜
        2024å¹´åº¦æ”¶å…¥æ€»è®¡9930ä¸‡å…ƒï¼Œæ”¯å‡ºæ€»è®¡9930ä¸‡å…ƒã€‚
        å…¶ä¸­ï¼šåŸºæœ¬æ”¯å‡º850ä¸‡å…ƒï¼Œé¡¹ç›®æ”¯å‡º9080ä¸‡å…ƒã€‚
        
        ä¸‰å…¬ç»è´¹æ”¯å‡º73.50ä¸‡å…ƒï¼Œå…¶ä¸­ï¼šå› å…¬å‡ºå›½15.20ä¸‡å…ƒï¼Œ
        å…¬åŠ¡ç”¨è½¦45.80ä¸‡å…ƒï¼Œå…¬åŠ¡æ¥å¾…12.50ä¸‡å…ƒã€‚""",
        
        """æ”¶å…¥æ”¯å‡ºå†³ç®—æ€»è¡¨
        ç¼–åˆ¶å•ä½ï¼šä¸Šæµ·å¸‚æ™®é™€åŒºè´¢æ”¿å±€
        2024å¹´åº¦
        é‡‘é¢å•ä½ï¼šä¸‡å…ƒ
        
        é¡¹ç›®                 å¹´åˆé¢„ç®—æ•°    è°ƒæ•´é¢„ç®—æ•°    å†³ç®—æ•°
        ä¸€ã€ä¸€èˆ¬å…¬å…±é¢„ç®—è´¢æ”¿æ‹¨æ¬¾  8500.00     9200.00     9150.00
        äºŒã€æ”¿åºœæ€§åŸºé‡‘é¢„ç®—è´¢æ”¿æ‹¨æ¬¾   500.00      800.00      780.00
        ä¸‰ã€å›½æœ‰èµ„æœ¬ç»è¥é¢„ç®—è´¢æ”¿æ‹¨æ¬¾   0.00        0.00        0.00
        
        æœ¬å¹´æ”¶å…¥åˆè®¡            9000.00    10000.00     9930.00
        æ”¯å‡ºæ€»è®¡               9000.00    10000.00     9930.00"""
    ]
    
    # åˆ›å»ºé…ç½®
    config = create_default_config()
    
    print("ğŸ§ª è¿è¡ŒAIè§„åˆ™æ£€æµ‹...")
    
    try:
        ai_findings = await run_ai_rules_batch(test_doc, config)
        print(f"âœ… AIæ£€æµ‹å®Œæˆï¼Œå‘ç°é—®é¢˜: {len(ai_findings)}")
        
        for i, finding in enumerate(ai_findings):
            print(f"\n  {i+1}. {finding.title}")
            print(f"     ä¸¥é‡ç¨‹åº¦: {finding.severity}")
            print(f"     æ¶ˆæ¯: {finding.message}")
            print(f"     é¡µé¢: {finding.page_number}")
            if finding.evidence:
                print(f"     è¯æ®: {finding.evidence}")
                
    except Exception as e:
        print(f"âŒ AIæ£€æµ‹å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()


def analyze_detection_gap():
    """åˆ†ææ£€æµ‹å·®è·"""
    print("\nğŸ” åˆ†ææ£€æµ‹å·®è·")
    print("=" * 50)
    
    print("ğŸ“Š å½“å‰æ£€æµ‹æƒ…å†µ:")
    print("  1. AIæ£€æµ‹: èƒ½å‘ç°é—®é¢˜ï¼Œä½†å¯èƒ½ä¸å¤Ÿå‡†ç¡®")
    print("  2. è§„åˆ™æ£€æµ‹: æ‰§è¡Œæ­£å¸¸ä½†å‘ç°çš„é—®é¢˜è¾ƒå°‘")
    print("  3. åˆå¹¶ç»“æœ: æœ€ç»ˆæ˜¾ç¤ºçš„é—®é¢˜æ•°é‡åå°‘")
    
    print("\nğŸ” å¯èƒ½çš„åŸå› :")
    print("  1. è§„åˆ™é€»è¾‘è¿‡äºä¸¥æ ¼ï¼Œå¯¼è‡´æ¼æ£€")
    print("  2. æ–‡æ¡£è§£æä¸å¤Ÿå‡†ç¡®ï¼Œå½±å“è§„åˆ™åŒ¹é…")
    print("  3. AIæ£€æµ‹é˜ˆå€¼è®¾ç½®ä¸å½“ï¼Œè¯¯æŠ¥æˆ–æ¼æŠ¥")
    print("  4. åˆå¹¶é€»è¾‘å¯èƒ½è¿‡æ»¤äº†æœ‰æ•ˆç»“æœ")
    
    print("\nğŸ’¡ å»ºè®®æ”¹è¿›æ–¹å‘:")
    print("  1. ä¼˜åŒ–è§„åˆ™é€»è¾‘ï¼Œæé«˜æ£€æµ‹æ•æ„Ÿåº¦")
    print("  2. æ”¹è¿›æ–‡æ¡£è§£æå‡†ç¡®æ€§")
    print("  3. è°ƒæ•´AIæ£€æµ‹å‚æ•°å’Œé˜ˆå€¼")
    print("  4. ä¼˜åŒ–ç»“æœåˆå¹¶ç®—æ³•")


async def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ” æ·±åº¦åˆ†ææ£€æµ‹é—®é¢˜")
    print("=" * 60)
    
    # 1. åˆ†ææ ·æœ¬æ–‡ä»¶
    analyze_sample_files()
    
    # 2. åˆ†æè§„åˆ™å®ç°
    analyze_rule_implementations()
    
    # 3. è¯¦ç»†æµ‹è¯•è§„åˆ™æ‰§è¡Œ
    test_rule_execution_detail()
    
    # 4. æµ‹è¯•AIæ£€æµ‹
    await test_ai_detection()
    
    # 5. åˆ†ææ£€æµ‹å·®è·
    analyze_detection_gap()
    
    print("\nâœ… åˆ†æå®Œæˆï¼")


if __name__ == "__main__":
    asyncio.run(main())