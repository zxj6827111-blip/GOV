# GovBudgetChecker AI版本 - 快速启动指南

## 🚀 一键启动所有服务

### 方法1: 使用PowerShell脚本 (推荐)

创建 `start_all_services.ps1`:

```powershell
# GovBudgetChecker AI版本 - 一键启动脚本
Write-Host "🚀 启动 GovBudgetChecker AI版本..." -ForegroundColor Green

# 检查当前目录
$currentDir = Get-Location
Write-Host "📁 当前目录: $currentDir" -ForegroundColor Yellow

# 1. 启动AI抽取器服务 (后台)
Write-Host "🤖 启动AI抽取器服务..." -ForegroundColor Cyan
Start-Process -FilePath "python" -ArgumentList "ai_extractor_service_v2.py" -WindowStyle Minimized

# 等待2秒
Start-Sleep -Seconds 2

# 2. 启动后端API服务 (后台)
Write-Host "🔧 启动后端API服务..." -ForegroundColor Cyan
Start-Process -FilePath "python" -ArgumentList "-m", "uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload" -WindowStyle Minimized

# 等待3秒
Start-Sleep -Seconds 3

# 3. 启动前端服务 (后台)
Write-Host "📱 启动前端服务..." -ForegroundColor Cyan
Start-Process -FilePath "cmd" -ArgumentList "/c", "cd app && npm run dev" -WindowStyle Minimized

# 等待5秒让服务启动
Write-Host "⏳ 等待服务启动..." -ForegroundColor Yellow
Start-Sleep -Seconds 5

# 4. 检查服务状态
Write-Host "🔍 检查服务状态..." -ForegroundColor Green

try {
    $backendHealth = Invoke-RestMethod -Uri "http://localhost:8000/health" -Method Get -TimeoutSec 5
    Write-Host "✅ 后端API: 正常 (版本: $($backendHealth.version))" -ForegroundColor Green
} catch {
    Write-Host "❌ 后端API: 异常" -ForegroundColor Red
}

try {
    $aiHealth = Invoke-RestMethod -Uri "http://localhost:9009/health" -Method Get -TimeoutSec 10
    Write-Host "✅ AI服务: 正常 (模型数: $($aiHealth.ai_client.available_models))" -ForegroundColor Green
} catch {
    Write-Host "❌ AI服务: 异常 (可能仍在启动中)" -ForegroundColor Yellow
}

# 5. 打开浏览器
Write-Host "🌐 打开浏览器..." -ForegroundColor Cyan
Start-Process "http://localhost:3000"

Write-Host "🎉 启动完成!" -ForegroundColor Green
Write-Host "📱 前端地址: http://localhost:3000" -ForegroundColor White
Write-Host "🔧 后端API: http://localhost:8000" -ForegroundColor White
Write-Host "🤖 AI服务: http://localhost:9009" -ForegroundColor White
```

### 方法2: 手动启动 (分步骤)

#### 步骤1: 启动AI抽取器服务
```bash
python ai_extractor_service_v2.py
```
**预期输出**: 
- AI服务启动在端口9009
- 4个AI模型加载完成
- 健康检查通过

#### 步骤2: 启动后端API服务
```bash
python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --reload
```
**预期输出**:
- FastAPI服务启动在端口8000
- 自动重载模式启用
- API文档可访问

#### 步骤3: 启动前端服务
```bash
cd app
npm run dev
```
**预期输出**:
- Next.js开发服务器启动
- 编译完成，无错误
- 可在浏览器访问

## 🔍 服务验证

### 健康检查命令
```powershell
# 后端API健康检查
Invoke-RestMethod -Uri "http://localhost:8000/health" -Method Get

# AI服务健康检查 (可能需要较长时间)
Invoke-RestMethod -Uri "http://localhost:9009/health" -Method Get -TimeoutSec 15

# 配置检查
Invoke-RestMethod -Uri "http://localhost:8000/config" -Method Get
```

### 预期响应
```json
// 后端API健康检查
{
  "status": "ok",
  "service": "GovBudgetChecker API",
  "version": "2.0.0",
  "timestamp": 1758712102.998286
}

// AI服务健康检查
{
  "status": "healthy",
  "ai_client": {
    "healthy": true,
    "available_models": 4,
    "tested_models": [],
    "timestamp": 1758711321.6163464
  },
  "version": "2.0.0"
}

// 配置检查
{
  "ai_enabled": true,
  "ai_extractor_url": "http://127.0.0.1:9009"
}
```

## 🛠️ 故障排除

### 常见问题及解决方案

#### 1. AI服务启动慢或超时
**原因**: AI模型加载需要时间，首次调用可能需要10-30秒
**解决方案**: 
- 增加超时时间到15-20秒
- 等待AI模型完全加载后再测试
- 检查.env文件中的API密钥是否正确

#### 2. 端口占用错误
**检查端口占用**:
```powershell
netstat -ano | findstr :3000
netstat -ano | findstr :8000  
netstat -ano | findstr :9009
```
**解决方案**: 终止占用进程或更改端口

#### 3. 前端编译错误
**常见原因**: 依赖包未安装或版本不兼容
**解决方案**:
```bash
cd app
npm install
npm run build  # 检查编译错误
```

#### 4. 后端API导入错误
**检查Python环境**:
```bash
python --version  # 确保Python 3.8+
pip list | grep fastapi  # 检查依赖包
```

## 📊 性能监控

### 进程监控
```powershell
# 查看所有相关进程
Get-Process | Where-Object {$_.ProcessName -match "python|node|uvicorn"} | Select-Object ProcessName, Id, CPU, WorkingSet

# 监控CPU使用率
while($true) {
    Get-Process | Where-Object {$_.ProcessName -match "python|node"} | Select-Object ProcessName, CPU
    Start-Sleep -Seconds 5
}
```

### 内存使用监控
```powershell
# 查看内存使用
Get-Process | Where-Object {$_.ProcessName -match "python|node"} | Select-Object ProcessName, @{Name="Memory(MB)";Expression={[math]::Round($_.WorkingSet/1MB,2)}}
```

## 🧪 完整流程测试

### 自动化测试脚本
```bash
python test_complete_flow.py
```

### 手动测试步骤
1. **访问前端**: http://localhost:3000
2. **上传PDF文件**: 选择`samples/bad/`中的文件
3. **启动分析**: 选择双模式分析
4. **查看结果**: 等待分析完成，查看检测结果

### 测试文件推荐
- **问题文件**: `samples/bad/上海市普陀区规划和自然资源局 2024 年度部门决算.pdf`
- **正常文件**: `samples/good/上海市普陀区财政局2024年度部门决算.pdf`
- **模板文件**: `samples/templates/附件2：部门决算模板.pdf`

## 🎯 开发模式 vs 生产模式

### 开发模式 (当前)
- **自动重载**: 代码变更自动重启
- **详细日志**: 完整的调试信息
- **热更新**: 前端代码实时更新

### 生产模式 (部署时)
```bash
# 后端生产启动
python -m uvicorn api.main:app --host 0.0.0.0 --port 8000 --workers 4

# 前端生产构建
cd app
npm run build
npm start
```

## 📋 环境要求检查清单

### 必需软件
- [ ] Python 3.8+ 已安装
- [ ] Node.js 16+ 已安装
- [ ] npm 或 yarn 已安装
- [ ] Git 已安装 (可选)

### 必需文件
- [ ] `.env` 文件存在且配置完整
- [ ] `app/package.json` 依赖已安装
- [ ] Python依赖包已安装

### 网络要求
- [ ] 可访问AI模型API (GLM、DeepSeek)
- [ ] 本地端口3000、8000、9009可用
- [ ] 防火墙允许本地服务通信

---

**快速启动完成后，系统将在以下地址可用**:
- 🌐 **用户界面**: http://localhost:3000
- 🔧 **API文档**: http://localhost:8000/docs  
- 🤖 **AI服务**: http://localhost:9009/health
- 📊 **系统状态**: http://localhost:8000/health